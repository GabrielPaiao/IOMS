import { PrismaClient, UserRole, CriticalityLevel, OutageStatus } from '@prisma/client';
import * as bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seeding do banco de dados...');

  // Limpar dados existentes (cuidado em produ√ß√£o!)
  console.log('üßπ Limpando dados existentes...');
  await prisma.messageRead.deleteMany();
  await prisma.chatMessage.deleteMany();
  await prisma.chatParticipant.deleteMany();
  await prisma.chatConversation.deleteMany();
  await prisma.notification.deleteMany();
  await prisma.outageHistory.deleteMany();
  await prisma.outageEnvironment.deleteMany();
  await prisma.workflowStep.deleteMany();
  await prisma.approvalWorkflow.deleteMany();
  await prisma.outage.deleteMany();
  await prisma.applicationKeyUser.deleteMany();
  await prisma.applicationLocation.deleteMany();
  await prisma.applicationEnvironment.deleteMany();
  await prisma.application.deleteMany();
  await prisma.invitation.deleteMany();
  await prisma.user.deleteMany();
  await prisma.company.deleteMany();

  // 1. Criar empresas
  console.log('üè¢ Criando empresas...');
  const company1 = await prisma.company.create({
    data: {
      name: 'Tech Solutions Ltd',
      description: 'Empresa de desenvolvimento de software e solu√ß√µes tecnol√≥gicas',
      domain: 'techsolutions.com'
    }
  });

  const company2 = await prisma.company.create({
    data: {
      name: 'Digital Innovations Corp',
      description: 'Corpora√ß√£o focada em inova√ß√µes digitais e transforma√ß√£o digital',
      domain: 'digitalinnovations.com'
    }
  });

  // 2. Criar usu√°rios
  console.log('üë• Criando usu√°rios...');
  const hashedPassword = await bcrypt.hash('123456', 10);

  const admin1 = await prisma.user.create({
    data: {
      email: 'admin@techsolutions.com',
      password: hashedPassword,
      firstName: 'Jo√£o',
      lastName: 'Silva',
      role: UserRole.ADMIN,
      companyId: company1.id,
      location: 'S√£o Paulo, SP'
    }
  });

  const keyUser1 = await prisma.user.create({
    data: {
      email: 'maria.santos@techsolutions.com',
      password: hashedPassword,
      firstName: 'Maria',
      lastName: 'Santos',
      role: UserRole.KEY_USER,
      companyId: company1.id,
      location: 'Rio de Janeiro, RJ'
    }
  });

  const keyUser2 = await prisma.user.create({
    data: {
      email: 'carlos.oliveira@techsolutions.com',
      password: hashedPassword,
      firstName: 'Carlos',
      lastName: 'Oliveira',
      role: UserRole.KEY_USER,
      companyId: company1.id,
      location: 'Belo Horizonte, MG'
    }
  });

  const dev1 = await prisma.user.create({
    data: {
      email: 'ana.costa@techsolutions.com',
      password: hashedPassword,
      firstName: 'Ana',
      lastName: 'Costa',
      role: UserRole.DEV,
      companyId: company1.id,
      location: 'S√£o Paulo, SP'
    }
  });

  const admin2 = await prisma.user.create({
    data: {
      email: 'admin@digitalinnovations.com',
      password: hashedPassword,
      firstName: 'Roberto',
      lastName: 'Pereira',
      role: UserRole.ADMIN,
      companyId: company2.id,
      location: 'Bras√≠lia, DF'
    }
  });

  const keyUser3 = await prisma.user.create({
    data: {
      email: 'lucia.ferreira@digitalinnovations.com',
      password: hashedPassword,
      firstName: 'L√∫cia',
      lastName: 'Ferreira',
      role: UserRole.KEY_USER,
      companyId: company2.id,
      location: 'Porto Alegre, RS'
    }
  });

  // 3. Criar aplica√ß√µes
  console.log('üöÄ Criando aplica√ß√µes...');
  
  // Aplica√ß√µes da Tech Solutions
  const app1 = await prisma.application.create({
    data: {
      name: 'E-commerce Platform',
      description: 'Plataforma de e-commerce completa com sistema de pagamentos e gest√£o de estoque',
      version: '2.1.4',
      companyId: company1.id,
      createdBy: admin1.id
    }
  });

  const app2 = await prisma.application.create({
    data: {
      name: 'CRM System',
      description: 'Sistema de gest√£o de relacionamento com cliente integrado com WhatsApp e Email',
      version: '1.8.2',
      companyId: company1.id,
      createdBy: admin1.id
    }
  });

  const app3 = await prisma.application.create({
    data: {
      name: 'Mobile Banking App',
      description: 'Aplicativo m√≥vel para opera√ß√µes banc√°rias com biometria e PIX',
      version: '3.2.1',
      companyId: company1.id,
      createdBy: keyUser1.id
    }
  });

  // Aplica√ß√µes da Digital Innovations
  const app4 = await prisma.application.create({
    data: {
      name: 'IoT Dashboard',
      description: 'Dashboard para monitoramento de dispositivos IoT em tempo real',
      version: '1.5.0',
      companyId: company2.id,
      createdBy: admin2.id
    }
  });

  const app5 = await prisma.application.create({
    data: {
      name: 'AI Analytics Platform',
      description: 'Plataforma de an√°lise de dados com intelig√™ncia artificial e machine learning',
      version: '2.0.0',
      companyId: company2.id,
      createdBy: keyUser3.id
    }
  });

  // 4. Criar ambientes das aplica√ß√µes
  console.log('üåç Criando ambientes...');
  
  // Ambientes para E-commerce Platform
  await prisma.applicationEnvironment.createMany({
    data: [
      { applicationId: app1.id, environment: 'Desenvolvimento' },
      { applicationId: app1.id, environment: 'Homologa√ß√£o' },
      { applicationId: app1.id, environment: 'Produ√ß√£o' },
      { applicationId: app1.id, environment: 'Staging' }
    ]
  });

  // Ambientes para CRM System
  await prisma.applicationEnvironment.createMany({
    data: [
      { applicationId: app2.id, environment: 'DEV' },
      { applicationId: app2.id, environment: 'QA' },
      { applicationId: app2.id, environment: 'PROD' }
    ]
  });

  // Ambientes para Mobile Banking App
  await prisma.applicationEnvironment.createMany({
    data: [
      { applicationId: app3.id, environment: 'Desenvolvimento' },
      { applicationId: app3.id, environment: 'Teste' },
      { applicationId: app3.id, environment: 'Pr√©-produ√ß√£o' },
      { applicationId: app3.id, environment: 'Produ√ß√£o' }
    ]
  });

  // Ambientes para IoT Dashboard
  await prisma.applicationEnvironment.createMany({
    data: [
      { applicationId: app4.id, environment: 'Development' },
      { applicationId: app4.id, environment: 'Testing' },
      { applicationId: app4.id, environment: 'Production' }
    ]
  });

  // Ambientes para AI Analytics Platform
  await prisma.applicationEnvironment.createMany({
    data: [
      { applicationId: app5.id, environment: 'Lab' },
      { applicationId: app5.id, environment: 'Staging' },
      { applicationId: app5.id, environment: 'Production' }
    ]
  });

  // 5. Criar localiza√ß√µes das aplica√ß√µes
  console.log('üìç Criando localiza√ß√µes...');
  
  // Localiza√ß√µes para E-commerce Platform
  const location1 = await prisma.applicationLocation.create({
    data: {
      applicationId: app1.id,
      code: 'SP-DC1',
      name: 'Data Center S√£o Paulo 1'
    }
  });

  const location2 = await prisma.applicationLocation.create({
    data: {
      applicationId: app1.id,
      code: 'RJ-DC1',
      name: 'Data Center Rio de Janeiro'
    }
  });

  // Localiza√ß√µes para CRM System
  const location3 = await prisma.applicationLocation.create({
    data: {
      applicationId: app2.id,
      code: 'AWS-US-EAST',
      name: 'AWS US East (Virginia)'
    }
  });

  // Localiza√ß√µes para Mobile Banking App
  const location4 = await prisma.applicationLocation.create({
    data: {
      applicationId: app3.id,
      code: 'AZURE-BR-SOUTH',
      name: 'Azure Brazil South'
    }
  });

  // Localiza√ß√µes para IoT Dashboard
  const location5 = await prisma.applicationLocation.create({
    data: {
      applicationId: app4.id,
      code: 'GCP-SA-EAST',
      name: 'Google Cloud Platform South America East'
    }
  });

  // Localiza√ß√µes para AI Analytics Platform
  const location6 = await prisma.applicationLocation.create({
    data: {
      applicationId: app5.id,
      code: 'HYBRID-CLOUD',
      name: 'Hybrid Cloud Infrastructure'
    }
  });

  // 6. Criar key users das aplica√ß√µes
  console.log('üîë Criando key users...');
  
  // Key users para E-commerce Platform
  await prisma.applicationKeyUser.createMany({
    data: [
      { applicationId: app1.id, userId: keyUser1.id },
      { applicationId: app1.id, userId: keyUser2.id }
    ]
  });

  // Key users para CRM System
  await prisma.applicationKeyUser.create({
    data: { applicationId: app2.id, userId: keyUser1.id }
  });

  // Key users para Mobile Banking App
  await prisma.applicationKeyUser.createMany({
    data: [
      { applicationId: app3.id, userId: keyUser1.id },
      { applicationId: app3.id, userId: keyUser2.id }
    ]
  });

  // Key users para IoT Dashboard
  await prisma.applicationKeyUser.create({
    data: { applicationId: app4.id, userId: keyUser3.id }
  });

  // Key users para AI Analytics Platform
  await prisma.applicationKeyUser.create({
    data: { applicationId: app5.id, userId: keyUser3.id }
  });

  // 7. Criar algumas outages de exemplo
  console.log('‚ö†Ô∏è Criando outages...');
  
  const now = new Date();
  const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
  const twoHoursAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000);
  const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
  const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

  // Outage conclu√≠da
  const outage1 = await prisma.outage.create({
    data: {
      applicationId: app1.id,
      companyId: company1.id,
      createdBy: keyUser1.id,
      title: 'Manuten√ß√£o programada do banco de dados',
      reason: 'Atualiza√ß√£o da vers√£o do PostgreSQL para corre√ß√£o de vulnerabilidades',
      description: 'Atualiza√ß√£o do PostgreSQL da vers√£o 14.2 para 14.8 incluindo patches de seguran√ßa',
      scheduledStart: twoHoursAgo,
      scheduledEnd: oneHourAgo,
      start: twoHoursAgo,
      end: oneHourAgo,
      criticality: CriticalityLevel.MEDIUM,
      planned: true,
      estimatedDuration: 3600, // 1 hora
      status: OutageStatus.COMPLETED,
      approvedBy: admin1.id,
      approvedAt: new Date(twoHoursAgo.getTime() - 30 * 60 * 1000),
      locationId: location1.id
    }
  });

  // Outage aprovada para amanh√£
  const outage2 = await prisma.outage.create({
    data: {
      applicationId: app2.id,
      companyId: company1.id,
      createdBy: keyUser1.id,
      title: 'Deploy da vers√£o 1.9.0',
      reason: 'Nova funcionalidade de integra√ß√£o com WhatsApp Business API',
      description: 'Deploy incluindo nova integra√ß√£o com WhatsApp, melhorias de performance e corre√ß√µes de bugs',
      scheduledStart: tomorrow,
      scheduledEnd: new Date(tomorrow.getTime() + 2 * 60 * 60 * 1000), // 2 horas
      start: tomorrow,
      end: new Date(tomorrow.getTime() + 2 * 60 * 60 * 1000),
      criticality: CriticalityLevel.HIGH,
      planned: true,
      estimatedDuration: 7200, // 2 horas
      status: OutageStatus.APPROVED,
      approvedBy: admin1.id,
      approvedAt: new Date(),
      locationId: location3.id
    }
  });

  // Outage pendente
  const outage3 = await prisma.outage.create({
    data: {
      applicationId: app3.id,
      companyId: company1.id,
      createdBy: keyUser2.id,
      title: 'Migra√ß√£o de infraestrutura',
      reason: 'Migra√ß√£o dos servi√ßos para nova regi√£o da Azure',
      description: 'Migra√ß√£o completa da aplica√ß√£o mobile banking para Azure Brazil South para reduzir lat√™ncia',
      scheduledStart: nextWeek,
      scheduledEnd: new Date(nextWeek.getTime() + 4 * 60 * 60 * 1000), // 4 horas
      start: nextWeek,
      end: new Date(nextWeek.getTime() + 4 * 60 * 60 * 1000),
      criticality: CriticalityLevel.CRITICAL,
      planned: true,
      estimatedDuration: 14400, // 4 horas
      status: OutageStatus.PENDING,
      locationId: location4.id
    }
  });

  // Outage da company2
  const outage4 = await prisma.outage.create({
    data: {
      applicationId: app4.id,
      companyId: company2.id,
      createdBy: keyUser3.id,
      title: 'Atualiza√ß√£o do sistema de monitoramento',
      reason: 'Implementa√ß√£o de novos sensores e dashboards',
      description: 'Atualiza√ß√£o do sistema para suportar 1000+ dispositivos IoT simult√¢neos',
      scheduledStart: new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000), // 3 dias
      scheduledEnd: new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000 + 3 * 60 * 60 * 1000), // 3 horas
      start: new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000),
      end: new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000 + 3 * 60 * 60 * 1000),
      criticality: CriticalityLevel.MEDIUM,
      planned: true,
      estimatedDuration: 10800, // 3 horas
      status: OutageStatus.APPROVED,
      approvedBy: admin2.id,
      approvedAt: new Date(),
      locationId: location5.id
    }
  });

  // 8. Criar ambientes das outages
  console.log('üåç Criando ambientes das outages...');
  
  await prisma.outageEnvironment.createMany({
    data: [
      { outageId: outage1.id, environment: 'Produ√ß√£o' },
      { outageId: outage2.id, environment: 'PROD' },
      { outageId: outage3.id, environment: 'Produ√ß√£o' },
      { outageId: outage3.id, environment: 'Pr√©-produ√ß√£o' },
      { outageId: outage4.id, environment: 'Production' }
    ]
  });

  console.log('‚úÖ Seeding completado com sucesso!');
  
  // Resumo dos dados criados
  console.log('\nüìä Resumo dos dados criados:');
  console.log(`üìä Empresas: 2`);
  console.log(`üë• Usu√°rios: 6`);
  console.log(`üöÄ Aplica√ß√µes: 5`);
  console.log(`üåç Ambientes: 18`);
  console.log(`üìç Localiza√ß√µes: 6`);
  console.log(`üîë Rela√ß√µes Key User: 7`);
  console.log(`‚ö†Ô∏è Outages: 4`);
  console.log(`üåç Ambientes de Outage: 5`);
  
  console.log('\nüîê Credenciais de acesso:');
  console.log('üìß Email: admin@techsolutions.com | üîë Senha: 123456 (ADMIN)');
  console.log('üìß Email: maria.santos@techsolutions.com | üîë Senha: 123456 (KEY_USER)');
  console.log('üìß Email: carlos.oliveira@techsolutions.com | üîë Senha: 123456 (KEY_USER)');
  console.log('üìß Email: ana.costa@techsolutions.com | üîë Senha: 123456 (DEV)');
  console.log('üìß Email: admin@digitalinnovations.com | üîë Senha: 123456 (ADMIN)');
  console.log('üìß Email: lucia.ferreira@digitalinnovations.com | üîë Senha: 123456 (KEY_USER)');
}

main()
  .catch((e) => {
    console.error('‚ùå Erro durante o seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
